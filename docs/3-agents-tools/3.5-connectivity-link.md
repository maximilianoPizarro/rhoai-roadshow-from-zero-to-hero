# ðŸ”— Connectivity Link

## Overview

**Connectivity Link** is Red Hat's service mesh solution that provides secure, observable, and manageable communication between services in Neuralbank's architecture. It enables:

- **Secure Communication**: Encrypted service-to-service communication
- **Traffic Management**: Load balancing, routing, and rate limiting
- **Observability**: Metrics, logs, and traces
- **Policy Enforcement**: Security and compliance policies

## Connectivity Link Architecture

Connectivity Link provides a comprehensive service mesh for Neuralbank's microservices architecture.

![Connectivity Link Overview](../../images/connectivity-link-policy-overview.png)

## Topology View

The Neuralbank topology shows how Connectivity Link connects all services:

![Neuralbank Topology with Connectivity Link](../../images/neuralbank-tology-connectivity-link.png)

### Complete Topology

![Connectivity Link Topology](../../images/connectivity-link-policy-topology.png)

The topology view shows:

- **Services**: All microservices in the Neuralbank architecture
- **Gateways**: Entry points for external traffic
- **HTTPRoutes**: Routing rules for service communication
- **Policies**: Applied policies (rate limiting, security, etc.)

### Topology Components

#### Gateway

![Topology Gateway](../../images/connectivity-link-policy-topology-gateway.png)

The Gateway is the entry point for external traffic:
- Receives requests from clients
- Routes to appropriate services
- Applies gateway-level policies

#### HTTPRoutes

![Topology HTTPRoutes](../../images/connectivity-link-policy-topology-httproutes.png)

HTTPRoutes define routing rules:
- **Path Matching**: Routes requests based on URL paths
- **Service Selection**: Directs traffic to specific services
- **Load Balancing**: Distributes requests across service instances

#### Policies

![Topology Policies](../../images/connectivity-link-policy-topology-policies.png)

Policies enforce rules and behaviors:
- **Rate Limiting**: Controls request throughput
- **Security**: Authentication and authorization
- **Traffic Shaping**: Quality of service controls

#### Internal Components

![Topology Internals](../../images/connectivity-link-policy-topology-internals.png)

Internal components handle:
- **Service Discovery**: Finding and connecting to services
- **Load Balancing**: Distributing traffic
- **Health Checking**: Monitoring service availability

## Rate Limiting

Connectivity Link provides rate limiting capabilities to protect services from overload and ensure fair resource usage.

### Rate Limit Policy Overview

![Rate Limit Policy](../../images/connectivity-link-policy-ratelimit.png)

Rate limiting policies:
- **Protect Services**: Prevent overload
- **Ensure Fairness**: Distribute resources equitably
- **Control Costs**: Manage API usage
- **Comply with SLAs**: Meet service level agreements

### Rate Limit Configuration

![Rate Limit API](../../images/connectivity-link-policy-ratelimit-api.png)

Rate limits can be configured:
- **Per Service**: Different limits for different services
- **Per User**: User-specific rate limits
- **Per Endpoint**: Endpoint-specific limits
- **Time Windows**: Limits over specific time periods

### Testing Rate Limiting

You can test rate limiting using `curl` commands:

#### Basic Rate Limit Test

```bash
# Test rate limit on customer-service-mcp
curl -v http://customer-service-mcp.neuralbank-mcp.svc.cluster.local:8080/api/credit-risk/query \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"customer_id": "CUST-12345"}'
```

#### Rate Limit in Action

![Rate Limit in Action](../../images/connectivity-link-policy-ratelimit-in-acction.png)

When rate limits are exceeded:
- **429 Too Many Requests**: HTTP status code returned
- **Retry-After Header**: Indicates when to retry
- **Rate Limit Headers**: Show current usage and limits

#### Advanced Rate Limit Test with Headers

```bash
# Test with multiple requests to trigger rate limit
for i in {1..20}; do
  echo "Request $i:"
  curl -v http://customer-service-mcp.neuralbank-mcp.svc.cluster.local:8080/api/credit-risk/query \
    -H "Authorization: Bearer YOUR_TOKEN" \
    -H "Content-Type: application/json" \
    -d '{"customer_id": "CUST-12345"}' \
    -w "\nHTTP Status: %{http_code}\nRate Limit Remaining: %{rate_limit_remaining}\n\n"
  sleep 0.5
done
```

#### Rate Limit API Details

![Rate Limit API Details](../../images/connectivity-link-policy-ratelimit-api-curl.png)

The rate limit API provides:
- **Current Usage**: How many requests have been made
- **Remaining Quota**: How many requests are allowed
- **Reset Time**: When the limit resets
- **Limit Information**: Total allowed requests

#### Example: Testing Rate Limit with curl

```bash
# Get rate limit information
curl -v http://customer-service-mcp.neuralbank-mcp.svc.cluster.local:8080/api/credit-risk/query \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"customer_id": "CUST-12345"}' \
  -i | grep -i "rate-limit"

# Expected headers:
# X-RateLimit-Limit: 100
# X-RateLimit-Remaining: 99
# X-RateLimit-Reset: 1640995200
# Retry-After: 60 (when limit exceeded)
```

### Rate Limit Policy Configuration

Rate limit policies are configured in Connectivity Link:

```yaml
apiVersion: networking.connectivity.redhat.com/v1alpha1
kind: RateLimitPolicy
metadata:
  name: customer-service-rate-limit
  namespace: neuralbank-mcp
spec:
  targetRef:
    group: networking.connectivity.redhat.com
    kind: HTTPRoute
    name: customer-service-route
  rules:
    - matches:
      - path:
          type: PathPrefix
          value: /api/credit-risk
      limits:
        - limit:
            requests: 100
            unit: Minute
          burst: 10
```

## Service Communication

Connectivity Link enables secure communication between services:

1. **Service Discovery**: Automatically discovers services
2. **mTLS**: Mutual TLS encryption between services
3. **Load Balancing**: Distributes requests across instances
4. **Health Checks**: Monitors service health
5. **Circuit Breaking**: Prevents cascading failures

## Integration with customer-service-mcp

The `customer-service-mcp` service uses Connectivity Link to:

- **Call Credit Risk Service**: Secure communication to backend services
- **Authenticate Requests**: Use Keycloak tokens for authorization
- **Respect Rate Limits**: Handle rate limit responses gracefully
- **Monitor Traffic**: Track request patterns and performance

## Observability

Connectivity Link provides observability through:

- **Metrics**: Request rates, latencies, error rates
- **Logs**: Request and response logging
- **Traces**: Distributed tracing (integrated with OpenTelemetry)
- **Dashboards**: Visual representation of service health

## Next Steps

Now that you understand Connectivity Link, let's test your `customer-service-mcp` service using **MCP Inspector** and **Cursor**.

Click **Test with MCP Inspector** to continue.

